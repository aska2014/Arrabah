function HtmlHandler(){this.fakeId=0}function Manager(e,t){this.routes=t;this.htmlHandler=e;this.allTabs=[];this.currentTab=null;this.currentFamily=0;this.firstUpdateAllTabsMessages=true}function Tab(e,t,n,r){this.name=e;this.type=t;this.id=n||0;this.lastMessageId=r||0}HtmlHandler.prototype.loadingMenuMembers=function(){$(".members-filter").fadeTo(200,.4)};HtmlHandler.prototype.loadedMenuMembers=function(){$(".members-filter").fadeTo(200,1)};HtmlHandler.prototype.removeAllMenuMembers=function(){$(".members-filter").html("")};HtmlHandler.prototype.syncronizeMenuMembers=function(e){var t=[];for(var n=0;n<e.length;n++){t.push(parseInt(e[n].id));if($("#member"+e[n].id).length==0){this.addMenuMember(e[n])}}$(".member-filter").each(function(){if(t.indexOf(parseInt($(this).attr("id").replace("member","")))<0){$(this).remove()}})};HtmlHandler.prototype.addMenuMember=function(e){$(".members-filter").append('<div class="member-filter" id="member'+e.id+'"><img src="'+e.image+'" /><div class="name">'+e.name+"</div></div>")};HtmlHandler.prototype.addNewMessage=function(e,t,n,r){if(n&&$("#message"+t.id).length>0){return}var i=$('<div class="message"><div class="member"><img src="'+t.image+'" /><div class="name"><a href="'+t.url+'">'+t.name+'</a></div></div><div class="clr"></div><div class="message-body">'+t.body+'</div><div class="clr"></div></div>');this.getHtmlTarget(e).find(".messages").append(i);if(r){i.css("display","none");i.slideDown({duration:100,complete:scrollTop})}if(!n){var s=this.getFakeId();i.fadeTo(0,"0.5");i.attr("id","fakeMessage"+s);return s}i.attr("id","message"+t.id)};HtmlHandler.prototype.setActive=function(e,t){$("#fakeMessage"+e).fadeTo(100,1);$("#fakeMessage"+e).attr("id","message"+t)};HtmlHandler.prototype.scrollDownTarget=function(e){var t=this.getHtmlTarget(e).find(".messages");t.scrollTop(t[0].scrollHeight)};HtmlHandler.prototype.canScrollDown=function(e){var t=this.getHtmlTarget(e).find(".messages");return t[0].scrollHeight-t.scrollTop()<=t.outerHeight()+50};HtmlHandler.prototype.createNewTab=function(e){var t=$('<div class="tab" target="'+e.getTargetId()+'">'+e.name+'<span class="close">×</span></div>');var n=$('<div class="chat-body" id="'+e.getTargetId()+'"><div class="top-body">هذه المحادثة بينك وبين <span>'+e.name+'</span>.</div><div class="clr"></div><div class="messages"></div></div>');$(".tabs").append(t);$(".all-tabs").append(n)};HtmlHandler.prototype.selectTab=function(e){$(".chat-body").removeClass("active-tab-body");this.getHtmlTarget(e).addClass("active-tab-body");$(".tab").removeClass("active-tab");this.getHtmlTab(e).addClass("active-tab");this.removeRedify(e)};HtmlHandler.prototype.tabExists=function(e){return this.getHtmlTarget(e).length>0};HtmlHandler.prototype.tabSelected=function(e){return this.getHtmlTab(e).hasClass("active-tab")};HtmlHandler.prototype.removeTab=function(e){this.getHtmlTab(e).remove();this.getHtmlTarget(e).remove()};HtmlHandler.prototype.redify=function(e){this.getHtmlTab(e).addClass("new-tab")};HtmlHandler.prototype.removeRedify=function(e){this.getHtmlTab(e).removeClass("new-tab")};HtmlHandler.prototype.getHtmlTab=function(e){return $(".tabs").find('[target="'+e.getTargetId()+'"]')};HtmlHandler.prototype.getHtmlTarget=function(e){return $("#"+e.getTargetId())};HtmlHandler.prototype.getTargetId=function(e){return e.attr("target")};HtmlHandler.prototype.getFakeId=function(){this.fakeId++;return this.fakeId};Manager.prototype.getTabFromHtml=function(e){for(var t=0;t<this.allTabs.length;t++){if(this.allTabs[t].getTargetId()==this.htmlHandler.getTargetId(e)){return this.allTabs[t]}}};Manager.prototype.addTab=function(e){this.allTabs.push(e)};Manager.prototype.getTabKey=function(e){for(var t=0;t<this.allTabs.length;t++){if(this.allTabs[t].equals(e)){return t}}return-1};Manager.prototype.removeTab=function(e){this.allTabs.splice(this.getTabKey(e),1);this.htmlHandler.removeTab(e)};Manager.prototype.changeFamily=function(e){this.currentFamily=e;this.htmlHandler.loadingMenuMembers();this.getOnlineUsers(e)};Manager.prototype.getOnlineUsers=function(e){var t=this;$.ajax({cache:false,type:"GET",data:"family="+e,url:this.routes.getOnlineUsers,success:function(e){t.htmlHandler.syncronizeMenuMembers(e);t.htmlHandler.loadedMenuMembers()}})};Manager.prototype.updateAllTabsMessages=function(){var e=[];var t=[];var n=[];for(var r=0;r<this.allTabs.length;r++){var i=this.allTabs[r];e.push(i.type);t.push(i.id);n.push(i.lastMessageId)}var s=this;$.ajax({cache:false,type:"GET",data:{types:e,ids:t,lastMessageIds:n},url:this.routes.requestChatMessages,success:function(e){if("newTabs"in e){var t=e.newTabs;var n;for(var r=0;r<t.length;r++){n=new Tab(t[r].name,t[r].type,t[r].id);s.openTab(n,true);s.redify(n)}}for(var r=0;r<s.allTabs.length;r++){var i=s.allTabs[r].getTargetId();if(i in e){var o=e[i].messages;var n=s.allTabs[r];var u=s.htmlHandler.canScrollDown(n);for(var a=o.length-1;a>=0;a--){s.htmlHandler.addNewMessage(n,o[a],true)}s.allTabs[r].lastMessageId=e[i].lastMessageId;if(!n.equals(s.getCurrentTab())){if(o.length>0)s.redify(n)}else{if(u&&o.length>0)s.htmlHandler.scrollDownTarget(n)}}}}})};Manager.prototype.sendChatMessage=function(e,t,n){var r=this.getCurrentTab();var i=this.htmlHandler.addNewMessage(r,{image:e,name:t,body:n},false);this.htmlHandler.scrollDownTarget(r);var s=this;$.ajax({cache:false,type:"POST",url:this.routes.sendChat,data:"description="+n+"&type="+r.type+"&id="+r.id,success:function(e){if(e.message=="success"){s.htmlHandler.setActive(i,e.messageId)}}})};Manager.prototype.openTab=function(e,t){if(!this.htmlHandler.tabExists(e)){this.htmlHandler.createNewTab(e);this.addTab(e)}if(!t)this.selectTab(e)};Manager.prototype.selectTab=function(e){this.currentTab=e;this.htmlHandler.selectTab(e);this.htmlHandler.scrollDownTarget(e)};Manager.prototype.closeTab=function(e){if(this.allTabs.length>1){this.removeTab(e);if(this.isCurrentTab(e)){this.selectTab(this.allTabs[0])}}};Manager.prototype.isCurrentTab=function(e){return e.equals(this.getCurrentTab())};Manager.prototype.redify=function(e){this.htmlHandler.redify(e)};Manager.prototype.getCurrentTab=function(){return this.currentTab};Manager.prototype.getCurrentFamily=function(){return this.currentFamily};Tab.prototype.getTargetId=function(){return this.type+"-"+this.id};Tab.prototype.equals=function(e){return this.type==e.type&&this.id==e.id}